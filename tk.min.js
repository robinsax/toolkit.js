/*
	# toolkit.js
	
	* DOM inspection and manipulation helpers
	* Live data-DOM mappings
	* AJAX
	
	Author Robin Saxifrage | https://github.com/robinsax/toolkit.js
	
	Licensed under Apache 2.0
*/
function createToolkit(){"use strict";function t(){b.debug&&(console.log.apply(null,arguments),null!=b.logElement)}function e(t,e){switch(s(t,[Array,"object","number"])){case 0:for(var n=0;n<t.length&&e(t[n],n)!==!1;n++);return;case 1:for(var r in t)if(e(r,t[r])===!1)break;return;case 2:for(var n=0;t>n&&e(n)!==!1;n++);return}}function n(t,e){var n=t.hasOwnProperty(e);return 2==arguments.length?n:n?t[e]:arguments[2]}function r(t,e){setTimeout(t,e)}function i(t,e,n){return t.length>e?arguments.length>3&&arguments[3]&&null==t[e]?n:t[e]:n}function s(t,e){e instanceof Array||(e=[e]);for(var n=-1,r=0;r<e.length;r++){var i=e[r];if(null==i){if(null==t){n=r;break}}else{if(typeof t==i){n=r;break}try{if(t instanceof i){n=r;break}}catch(s){}}}if(-1==n)throw new TypeError("Incorrect parameter type "+typeof param+" (expected one of "+e+")");return n}function a(t){if("function"==typeof t){var e=[].slice.call(arguments);if(e.splice(0,1),i(arguments,1,!0))for(var n=0;n<e.length;n++)e[n]instanceof Element&&(e[n]=new u(e[n]));return t.apply(null,e)}return t}function u(t){var o=this;this.set=function(){switch(t instanceof u&&(t=t.set.splice()),s(t,[Element,Window,Array,"string"])){case 0:case 1:return[t];case 2:for(var e=0;e<t.length;e++){var n=t[e];n instanceof u&&(t[e]=n.set[0])}return t;case 3:return document.querySelectorAll(t)}}(),this.parent=i(arguments,1,null),this.length=this.set.length,this.empty=0==this.length,this.debug=function(){return console.log(i(arguments,0,"Debug")+":",this),this},this.back=function(){if(null==this.parent)throw c("Called back() without parent");return this.parent},this.reverse=function(){var t=this.set.slice();return t.reverse(),new u(t,this)},this.ith=function(t){var e=i(arguments,1,!1);return e?this.set[t]:new u(this.set[t],this)},this.reduce=function(t){s(t,["string","function"]);var e=[],n=i(arguments,1,-1);return this.iter(function(r,i){return r.is(a(t,r,i))&&(e.push(r),n>=0&&e.length==n)?!1:void 0}),new u(e,this)},this.extend=function(t){switch(s(t,[u,Array])){case 0:t=t.set;case 1:var e=[];this.iter(function(t,n){e.push(t)},!1);for(var n=0;n<t.length;n++)e.push(t[n]);return new u(e,this)}},this.parent=function(){return this.parents("*",!1)},this.parents=function(){var t=arguments.length>0?arguments[0]:null,e=arguments.length>1?arguments[1]:!0,n=[];return s(t,[null,"string","function"]),s(e,["boolean"]),e?this.iter(function(e,r){for(var i=e.parentNode;i!==document;)(null==t||i.matches(a(t,e,r)))&&n.push(i),i=i.parentNode},!1):this.iter(function(e,r){var i=e.parentNode;(null==t||i.matches(a(t,e,r)))&&n.push(i)},!1),new u(n,this)},this.children=function(){var t=[],e=arguments.length>0?arguments[0]:"*",n=arguments.length>1?arguments[1]:!0;return n?this.iter(function(n,r){for(var i=n.querySelectorAll(a(e,n,r)),s=0;s<i.length;s++){var u=i[s];-1==t.indexOf(u)&&t.push(u)}},!1):this.iter(function(n,r){for(var i=n.children,s=0;s<i.length;s++){var u=i[s];(null==e||u.matches(a(e,n,r)))&&t.push(u)}},!1),new u(t,this)},this.copy=function(){return new u(this.set[0].cloneNode(!0),this)},this.equals=function(t){switch(s(t,[Element,Array,u])){case 0:return 1==o.length&&o.set[0]==t;case 2:t=t.set;case 1:var n=!1;return e(t,function(t){return-1==o.set.indexOf(t)?(n=!0,!1):void 0}),e(o.set,function(e){return-1==t.indexOf(e)?(n=!0,!1):void 0}),!n&&o.length==t.length}},this.iter=function(t){for(var e=arguments.length>1?arguments[1]:!0,n=0;n<this.set.length;n++){var r=this.set[n];if(e&&(r=new u(r,this)),t(r,n)===!1)break}return this},this.is=function(t){s(t,["string","function"]);for(var e=0;e<this.length;e++){var n=this.set[e];if(!n.matches(a(t,n,e)))return!1}return!0},this.classes=function(){var t=[];return this.iter(function(e){for(var n=e.className.split(/\s+/),r=0;r<n.length;r++){var i=n[r];-1==t.indexOf(i)&&t.push(i)}},!1),t},this.value=function(){if(arguments.length>0){var t=arguments[0];return this.iter(function(e,n){e.value=t},!1),this}return this.set[0].value},this.attr=function(t){switch(s(t,["string","object"])){case 0:if(!(arguments.length>1))return this.set[0].hasAttribute(t)?this.set[0].getAttribute(t):null;var e=t,n=arguments[1];switch(s(n,[null,"string","function"])){case 0:this.iter(function(t,n){t.removeAttribute(e,null)},!1);break;default:this.iter(function(t,r){t.setAttribute(a(e,t,r),a(n,t,r))},!1)}break;case 1:this.iter(function(e,n){for(var r in t)e.setAttribute(r,a(t[r],e,n))},!1)}return this},this.css=function(t){function e(t,e){t=t.replace(/-([a-z])/g,function(t){return t[1].toUpperCase()}),o.iter(function(n,r){n.style[t]=a(e,n,r)},!1)}switch(s(t,["string","object"])){case 0:if(!(arguments.length>1))return window.getComputedStyle(this.set[0]).getPropertyValue(t);e(t,arguments[1]);break;case 1:for(var n in t)e(n,t[n])}return this},this.on=function(t){function e(t,e){o.iter(function(r,i){var s=n(r,"tkEventListeners",null);null==s&&(s=[],r.tkEventListeners=s);var o={event:a(t,r,i),func:function(t){e(new u(r),t,i)}};s.push(o),r.addEventListener(o.event,o.func)},!1)}switch(s(t,["function","string","object"])){case 0:case 1:e(t,arguments[1]);break;case 2:for(var r in t)e(r,t[r])}return this},this.off=function(t){return this.iter(function(r){var i=n(r,"tkEventListeners",[]),s=[];e(i,function(e,n){e.event==t&&(r.removeEventListener(e.event,e.func),s.push(n))}),e(s,function(t){i=i.splice(t,1)})},!1),this},this.classify=function(t){function e(t,n,i){var s="."+t,u=" "+t;"toggle"==n&&(n=function(t,e){return!t.is(s)}),o.iter(function(o,c){var h=a(n,o,c);if(h)o.is(s)||(o.set[0].className+=u);else if(o.is(s)){var f=o.classes();f.splice(f.indexOf(t),1),o.set[0].className=f.join(" ")}var l=a(i,o,c);l>=0&&r(function(){e(t,!h,-1)},l)})}switch(s(t,["string","object"])){case 0:e(t,i(arguments,1,!0),i(arguments,2,-1));break;case 1:for(var n in t)e(n,t[n])}return this},this.remove=function(){return this.iter(function(t){null!=t.parentNode&&t.parentNode.removeChild(t)},!1),this},this.append=function(t){switch(s(t,[u,Element])){case 0:return t.iter(function(t){t.remove(),o.set[0].appendChild(t.set[0]),b.bindFunction(t)}),t;case 1:return o.set[0].appendChild(t),b.bindFunction(t),new u(t,this)}},this.prepend=function(t){switch(s(t,[u,Element])){case 0:return t.reverse().iter(function(e){e.remove(),o.set[0].insertBefore(e.set[0],o.set[0].firstChild),b.bindFunction(t)}).reverse(),t;case 1:return o.set[0].insertBefore(t,this.set[0].firstChild),b.bindFunction(t),new u(t,this)}},this.html=function(){if(arguments.length>0){var t=arguments[0];return this.iter(function(e,n){e.innerHTML=a(t,e,n)},!1),this}return this.set[0].innerHTML},this.text=function(){if(arguments.length>0){var t=arguments[0];return this.iter(function(e,n){e.textContent=a(t,e,n)},!1),this}return this.set[0].textContent},this.select=function(){return this.set[0].select(),this},this.offset=function(){for(var t=0,e=0,n=this.set[0];null!=n;)t+=n.offsetLeft,e+=n.offsetTop,n=n.offsetParent;return{x:t,y:e}},this.size=function(){var t=this.set[0],e=t.getBoundingClientRect(),n={width:e.width,height:e.height};if(i(arguments,0,!1)){var r=window.getComputedStyle(t,null);n.width+=r.getPropertyValue("margin-left")+r.getPropertyValue("margin-right"),n.height+=r.getPropertyValue("margin-top")+r.getPropertyValue("margin-bottom"),"border-box"==r.getPropertyValue("box-sizing")&&(n.width+=r.getPropertyValue("padding-left")+r.getPropertyValue("padding-right"),n.height+=r.getPropertyValue("padding-top")+r.getPropertyValue("padding-bottom"))}return n}}function c(t){this.message=t}function h(t){this.message=t}function f(t,r,s){function a(t){function s(e,n){var r=e.attr(n);return null!=r?(t&&e.attr(n,null),r.split(/\s+/g)):[]}r.children("["+x+"]").iter(function(t,r){var a=s(t,x),u=s(t,P),o=s(t,k),c=s(t,C);e(a,function(e,r){n(p,e)||(p[e]=[]),p[e].push({e:t,onto:i(u,r,"html"),viewWith:i(o,r,"-"),callback:i(c,r,"-")})})})}function u(t){var n=i(arguments,1,o[t]);if(!(n instanceof l)){var r=S.prop(p,t,null);null!=r&&e(r,function(e,r){if(n instanceof Array)o[t]=new l(n,g[t],e.e,c);else{var i="-"!=e.viewWith?c[e.viewWith](n,t):n;if("html"==e.onto)e.e.html(i);else{if(!e.onto.startsWith("attr"))throw h("Invalid bind "+x+'="'+e.onto+'"');e.e.attr(e.onto.split(":")[1],i)}"-"!=e.callback&&c[e.callback](n)}})}}var o=this,c=s._funcs,f=Object.getOwnPropertyNames(t),g={};this.node=r,this.parent=s,this.remove=function(){s.remove(this,!0)},this.extract=function(){var t={};return e(f,function(e,n){var r=o[e];r instanceof l&&(r=r.extract()),t[e]=r}),t};var p={};a(!1),e(p,function(n,r){t[n]instanceof Array&&e(r,function(t){g[n]=t.e.children("*",!1).remove()})}),p={},a(!0),r.children("["+E+"]").on("keyup",function(t){o[t.attr(E)]=t.value()}),r.children("["+O+"]").on(function(t){return t.is("["+A+"]")?t.attr(A):"click"},function(t,e){c[t.attr(O)](o,t,e)}),e(f,function(e){Object.defineProperty(o,e,function(t,e){var n=t;return{get:function(){return n},set:function(t){n instanceof l&&n.remove(),n=t,u(e,n)}}}(t[e],e)),u(e)})}function l(t,r,s,a){function u(t,e){Object.defineProperty(c,""+t,function(){var t=e;return{get:function(){return t},set:function(e){t=new f(o,t.node,c)},configurable:!0}}())}var c=this;e(b.globalTemplateFunctions,function(t,e){null==n(a,t,null)&&(a[t]=e)}),this.length=0,this._funcs=a,this.remap=function(t){for(;this.length>0;)this.remove(0);e(t,function(t){c.push(t)})},this.extract=function(){for(var t=[],e=0;e<this.length;e++){var n=this[e];n instanceof f&&(n=n.extract()),t.push(n)}return t},this.push=function(){for(var t=0;t<arguments.length;t++){var e=arguments[t],n=r.copy();u(c.length,new f(e,n,c)),c.length++,s.append(n)}},this.indexOf=function(t){for(var e=0;e<this.length;e++)if(this[e]==t)return e;return-1},this.remove=function(){if(arguments.length>0){var t=arguments[0];i(arguments,1,!1)&&(t=this.indexOf(t)),this[t].node.remove(),delete this[t];for(var e=t+1;e<this.length;e++){var n=this[e];delete this[e],u(e-1,n)}this.length--}else for(;this.length>0;)this.remove(0)},this.remap(t)}function g(){var t=i.on(arguments),n=document.createElement(t(0,"div"));return n.className=t(1,""),n.innerHTML=t(2,""),e(t(3,{}),function(t,e){n.setAttribute(t,e)}),new u(n)}function p(t,n,r,s){var a=i(arguments,4,s),n=n.toUpperCase();(r instanceof f||r instanceof l)&&(r=r.extract());var u=new XMLHttpRequest;u.onreadystatechange=function(){if(4==this.readyState){var t=this.status,e=JSON.parse(this.responseText);(400>t?s:a)(e,t)}};var o;if("GET"==n)t+="?",e(r,function(e,n){t+=e+"="+encodeURIComponent(n)}),u.open(n,t,!0),o="";else{if("POST"!=n)throw"Unsupported method "+n;u.open("POST",t,!0),u.setRequestHeader("Content-Type","application/json"),o=JSON.stringify(r)}e(L,function(t){t(u,o)}),u.send(o)}function v(t,e,n){var r=typeof t;if("string"==r||"number"==r||"boolean"==r)return t;var s=!(t instanceof Array);s&&(t=[t]);var a=new l(t,N[e],n,i(arguments,3,{}));return s?a[0]:a}function m(t){return j.push(t),S}function d(){var n=S(b.templateContainer).remove();n.children("["+T+"]",!1).iter(function(t){N[t.attr(T)]=t});t("Loaded templates:",N),e(j,function(t){t()})}Element.prototype.matches||(Element.prototype.matches=Element.prototype.msMatchesSelector);var b={templateContainer:".tk-templates",dataPrefix:"tk",globalTemplateFunctions:{},bindFunction:function(){},debug:!1,logElement:null};if(arguments.length>0){var w=arguments[0];for(var y in w)b[y]=w[y]}var x=b.dataPrefix+"-bind",P=b.dataPrefix+"-onto",k=b.dataPrefix+"-via",E=b.dataPrefix+"-src",C=b.dataPrefix+"-callback",O=b.dataPrefix+"-event",A=b.dataPrefix+"-on",T=b.dataPrefix+"-template";t.millis=function(){var t=new Date;return t.getTime()},i.on=function(t){return function(e,n){return i(t,e,n,i(arguments,2,!1))}};var L=[];p.processor=function(t){return L.push(t),S};var N={},j=[],S=function(t){return new u(t)};return S.config=b,S.prop=n,S.debug=t,S.varg=i,S.defer=r,S.iter=e,S.e=g,S.request=p,S.mapping=v,S.templateMap=N,S.init=m,S.types={ToolkitInstance:u,MappedObject:f,MappedArray:l,ChainingError:c},/complete|loaded|interactive/.test(document.readyState)?d():window.addEventListener("DOMContentLoaded",d),S}